<html>
<head>
    <script>
        window.onload = function () {
            var currentTemp = 0;
            var brewTarget = 100;
            var steamTarget = 145;
            var tempOffset = 8;
            var mode = 'brew';
            var brewData = {target: [], output: []};
            var steamData = {target: [], output: []};
            var labels = [];
            var data = {
                labels: labels,
                datasets: [{
                    type: 'line',
                    label: 'Temperature',
                    data: [],
                    backgroundColor: function () {
                        var targetTemp = (mode == 'brew') ? brewTarget : steamTarget;
                        if(currentTemp > (targetTemp + 1)) return '#331F2E';
                        if(currentTemp < (targetTemp - 1)) return '#FF6384';
                        else return '#63FF8F';
                    },
                    yAxisID: 'y',
                }, {
                    type: 'bar',
                    label: 'Output',
                    data: brewData.output,
                    backgroundColor: "#63FFDD",
                    yAxisID: 'y1',
                }],
            };

            const options = {
                spanGaps: 1000,
                responsive: true,
                animations: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                plugins: {
                    decimation: {
                        enabled: 'true',
                        algorithm: 'lttb',
                        samples: 10,
                    },
                    title: {
                        display: true,
                        text: "Brew Temperature",
                    },
                },
                scales: {
                    x: {
                        type: 'timeseries',
                        time: {
                            unit: 'second',
                        },
                        ticks: {
                            display:false,
                        },
                        title: {
                            display: true,
                            text: "Time",
                        },
                        stepSize: 30,
                    },
                    y: {
                        suggestedMax: brewTarget,
                        title: {
                            display: true,
                            text: "Temperature",
                        },
                        position: 'left',
                        grid: {
                            color: function(context) {
                                if(context.tick.value == brewTarget) return "#FF6384";
                            },
                        },
                    },
                    y1: {
                        suggestedMax: 1000,
                        title: {
                            display: true,
                            text: "Output",
                        },
                        position: "right",
                    },
                },
            }

            const actions = [{
                name: "Brew Temps",
                id: "brew",
                handler() {
                    chart.options.scales.y.suggestedMax = brewTarget;
                    chart.options.plugins.title.text = "Brew Temperature";
                    chart.options.scales.y.grid.color = function(context) {
                        if(context.tick.value == brewTarget) return "#FF6384";
                    };
                    chart.data.datasets[1].data = brewData.output;
                    mode = 'brew';
                    chart.update();
                    updateElements();
                },
            }, {
                name: "Steam Temps",
                id: "steam",
                handler() {
                    chart.options.scales.y.suggestedMax = steamTarget;
                    chart.options.plugins.title.text = "Steam Temperature";
                    chart.options.scales.y.grid.color = function(context) {
                        if(context.tick.value == steamTarget) return "#FF6384";
                    };
                    chart.data.datasets[1].data = steamData.output;
                    mode = 'steam';
                    chart.update();
                    updateElements();
                }
            }];
            
            function updateElements(){
                var targetTemp = (mode == "brew") ? brewTarget : steamTarget;

                var targetLabel = document.getElementById("target_label");
                targetLabel.innerHTML = "Target: " + targetTemp + " C";

                var switchButton = document.getElementById("switch_" + mode);
                switchButton.classList.add("active");

                var inactiveSwitch = (mode == "brew") ? document.getElementById("switch_steam") : document.getElementById("switch_brew");
                inactiveSwitch.classList.remove("active");

                var offsetLabel = document.getElementById("offset_label");
                offsetLabel.innerHTML = "Offset: " + tempOffset + " C";
            }

            function incrementTarget(){
                var maxTemp = (mode == "brew") ? 105 : 155;
                if(mode == "brew") brewTarget = (brewTarget < maxTemp) ? brewTarget + 0.5 : maxTemp;
                else steamTarget = (steamTarget < maxTemp) ? steamTarget + 0.5 : maxTemp;
                callServer("/increment_target", "POST", mode);
                updateElements();
            }

            function decrementTarget(){
                var minTemp = (mode == "brew") ? 85 : 145;
                if(mode == "brew") brewTarget = (brewTarget > minTemp) ? brewTarget - 0.5 : minTemp;
                else steamTarget = (steamTarget > minTemp) ? steamTarget - 0.5 : minTemp;
                callServer("/decrement_target", "POST", mode);
                updateElements();
            }

            function incrementOffset(){
                if(tempOffset < 15) tempOffset += 0.5;
                callServer("/set_offset", "POST", mode, tempOffset);
                updateElements();
            }

            function decrementOffset(){
                if(tempOffset > 0) tempOffset -= 0.5;
                callServer("/set_offset", "POST", tempOffset);
                updateElements();
            }

            const ctx = document.getElementById('tempChart').getContext('2d');
            var chart = new Chart(ctx, {
                data: data,
                options: options,
            });

            const container = document.getElementById('tempContainer');
            actions.forEach(function(action){
                const button = document.getElementById("switch_" + action.id);
                button.onclick = action.handler;
            });
            
            function callServer(url, method, handler){
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function(){
                    if (this.readyState == 4 && this.status == 200) {
                        if(typeof handler == "function") handler(this);
                    }
                }
                xhttp.open(method, url, true);
                xhttp.send(handler);
            }

            function refreshTemps(){
                return callServer("/get_temps", "GET", function(inherit){
                    var tempData = JSON.parse(inherit.response);
                    var time = Date.now();

                    if(labels.length == 0) {
                        [brewTarget, steamTarget, tempOffset] = [tempData.brew.target, tempData.steam.target, tempData.offset]
                    }

                    labels.push(time);
                    currentTemp = tempData.temperature;
                    chart.data.datasets[0].data.push(currentTemp);
                    brewData.output.push(tempData.brew.output);
                    steamData.output.push(tempData.steam.output);

                    if(chart.data.datasets[0].data.length > 120) {
                        labels.shift();
                        chart.data.datasets[0].data.shift();
                        brewData.output.shift();
                        steamData.output.shift();
                    }

                    chart.update();
                    updateElements();
                    refreshTemps();
                });
            };
            refreshTemps();
            // [brewTarget, steamTarget, tempOffset] = refreshTemps();
            callServer("/get_tunings", "GET", function(inherit){
                var tempData = JSON.parse(inherit.response);
                Object.entries(tempData).forEach(entry => {
                    const [name, value] = entry;
                    var input = document.getElementById(name);
                    input.value = value;
                });
            });

            document.getElementById("targetplus").onclick = incrementTarget;
            document.getElementById("targetminus").onclick = decrementTarget;
            document.getElementById("offsetplus").onclick = incrementOffset;
            document.getElementById("offsetminus").onclick = decrementOffset;
        }
    </script>
</head>
<body class="container">
    <div class="chart-container container" id="tempContainer">
        <canvas class="justify-content-md-center row" id="tempChart"></canvas>
        <div class="justify-content-md-center row">
            <div class="switch-button-container col">
                <button class="btn btn-outline-primary active" id="switch_brew"> Brew Temps </button>
                <button class="btn btn-outline-primary" id="switch_steam"> Steam Temps </button>
            </div>
            <div class="target-button-container col"> 
                <label class="form-label col" id="target_label"> Target: 100 C</label>
                <button class="btn btn-outline-danger" id="targetplus"> + </button>
                <button class="btn btn-outline-secondary" id="targetminus"> - </button>
            </div>
            <div class="offset-button-container col"> 
                <label class="form-label" id="offset_label"> Offset: 8 C</label>
                <button class="btn btn-outline-danger" id="offsetplus"> + </button>
                <button class="btn btn-outline-secondary" id="offsetminus"> - </button>
            </div>
        </div>
    </div>
    <div class="controller-container container" id="tempController">
        <label for="tunings-form" class="form-label"> Tunings: </label>
        <form class="row justify-content-md-center" id="tunings-form">
            <div class="tuning-button input-group col">
                <span for="kp" class="input-group-text"> Kp: </span>
                <input class="tuning-input form-control" type="text" id="kp" value="" placeholder="Proportional" min="0">
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kpplus"> + </button>
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kpminus"> - </button>
            </div>
            <div class="tuning-button input-group col">
                <span for="kp" class="input-group-text"> Ki: </span>
                <input class="tuning-input form-control" type="text" id="ki" value="" placeholder="Integral" min="0">
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kiplus"> + </button>
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kiminus"> - </button>
            </div>
            <div class="tuning-button input-group col">
                <span for="kp" class="input-group-text"> Kd: </span>
                <input class="tuning-input form-control" type="text" id="kd" value="" placeholder="Derivative" min="0">
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kdplus"> + </button>
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kdminus"> - </button>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
</body>
</html>