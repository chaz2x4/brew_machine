<html >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gaggia - Homebrew Server</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha256-djO3wMl9GeaC/u6K+ic4Uj/LKhRUSlUFcsruzS7v5ms=" crossorigin="anonymous">
    <script>
        window.onload = function () {
            var brewTarget = 100;
            var steamTarget = 145;
            var tempOffset = -8;
            var cycleTime = 2000;
            var mode = 'brew';
            var tempData = [];
            var brewData = [];
            var steamData = [];
            var labels = [];
            var data = {
                labels: labels,
                datasets: [{
                    type: 'line',
                    label: 'Temperature',
                    data: [],
                    backgroundColor: function (context) {
                        var pointTemp = context.dataset.data[context.dataIndex];
                        var targetTemp = (mode == 'brew') ? brewTarget : steamTarget;
                        if(pointTemp > (targetTemp + 0.5)) return '#FF6384';
                        if(pointTemp < (targetTemp - 0.5)) return '#331F2E';
                        else return '#63FF8F';
                    },
                    yAxisID: 'y',
                }, {
                    type: 'bar',
                    label: 'Output',
                    data: brewData,
                    backgroundColor: "#63FFDD",
                    yAxisID: 'y1',
                }],
            };

            const options = {
                spanGaps: 1000,
                responsive: true,
                animations: true,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                plugins: {
                    decimation: {
                        enabled: 'true',
                        algorithm: 'lttb',
                        samples: 10,
                    },
                    title: {
                        display: true,
                        text: "Brew Temperature",
                    },
                },
                scales: {
                    x: {
                        type: 'timeseries',
                        time: {
                            unit: 'second',
                        },
                        ticks: {
                            callback: function(value, index) {
                                if((index % 5 == 0)) return value;
                            }
                        },
                        title: {
                            display: true,
                            text: "Time",
                        },
                        spanGaps: 1000 * 60,
                    },
                    y: {
                        suggestedMax: brewTarget,
                        title: {
                            display: true,
                            text: "Temperature",
                        },
                        position: 'left',
                        grid: {
                            color: function(context) {
                                if(context.tick.value == brewTarget) return "#FF6384";
                            },
                        },
                    },
                    y1: {
                        suggestedMin: cycleTime,
                        suggestedMax: cycleTime,
                        title: {
                            display: true,
                            text: "Output",
                        },
                        position: "right",
                    },
                },
            }

            const actions = [{
                name: "Brew Temps",
                id: "brew",
                handler() {
                    chart.options.scales.y.suggestedMax = brewTarget;
                    chart.options.plugins.title.text = "Brew Temperature";
                    chart.options.scales.y.grid.color = function(context) {
                        if(context.tick.value == brewTarget) return "#FF6384";
                    };
                    chart.data.datasets[1].data = brewData;
                    mode = 'brew';
                    chart.update();
                    chart.render();
                    updateElements();
                    refreshTunings();
                },
            }, {
                name: "Steam Temps",
                id: "steam",
                handler() {
                    chart.options.scales.y.suggestedMax = steamTarget;
                    chart.options.plugins.title.text = "Steam Temperature";
                    chart.options.scales.y.grid.color = function(context) {
                        if(context.tick.value == steamTarget) return "#FF6384";
                    };
                    chart.data.datasets[1].data = steamData;
                    mode = 'steam';
                    chart.update();
                    chart.render();
                    updateElements();
                    refreshTunings();
                }
            }];
            
            function updateElements(){
                var targetTemp = (mode == "brew") ? brewTarget : steamTarget;

                var targetLabel = document.getElementById("target_label");
                targetLabel.innerHTML = "Target: " + targetTemp + " C";

                var switchButton = document.getElementById("switch_" + mode);
                switchButton.classList.add("active");

                var inactiveSwitch = (mode == "brew") ? document.getElementById("switch_steam") : document.getElementById("switch_brew");
                inactiveSwitch.classList.remove("active");

                var offsetLabel = document.getElementById("offset_label");
                offsetLabel.innerHTML = "Offset: " + tempOffset + " C";
            }

            function incrementTarget(){
                var maxTemp = (mode == "brew") ? 105 : 155;
                if(mode == "brew") brewTarget = (brewTarget < maxTemp) ? brewTarget + 0.5 : maxTemp;
                else steamTarget = (steamTarget < maxTemp) ? steamTarget + 1 : maxTemp;
                callServer.post("/increment_target", mode);
                updateElements();
            }

            function decrementTarget(){
                var minTemp = (mode == "brew") ? 85 : 145;
                if(mode == "brew") brewTarget = (brewTarget > minTemp) ? brewTarget - 0.5 : minTemp;
                else steamTarget = (steamTarget > minTemp) ? steamTarget - 1 : minTemp;
                callServer.post("/decrement_target", mode);
                updateElements();
            }

            function incrementOffset(){
                if(tempOffset < 15) tempOffset += 0.5;
                callServer.post("/set_offset", tempOffset);
                updateElements();
            }

            function decrementOffset(){
                if(tempOffset > -15) tempOffset -= 0.5;
                callServer.post("/set_offset", tempOffset);
                updateElements();
            }

            var tunings_open = false;
            function changeTunings() {
                var button = this;
                if(tunings_open) {
                    button.classList.remove('active');
                    button.innerHTML = "Setting Tunings...";
                    button.disabled = true;
                    tunings_open = false;
                    var kp = document.getElementById("kp");
                    var ki = document.getElementById("ki");
                    var kd = document.getElementById("kd");
                    var tunings = [mode, kp.value, ki.value, kd.value];
                    callServer.post("/set_tunings", tunings , function(request){
                        if(request) {
                            if(request.status == 200){
                                button.disabled = false;
                                button.innerHTML = "Set Tunings:";
                            }
                        }
                    })
                }
                else {
                    button.classList.add('active');
                    button.innerHTML = "Submit";
                    tunings_open = true;
                }
            }

            const ctx = document.getElementById('tempChart').getContext('2d');
            var chart = new Chart(ctx, {
                data: data,
                options: options,
            });

            const container = document.getElementById('tempContainer');
            actions.forEach(function(action){
                const button = document.getElementById("switch_" + action.id);
                button.onclick = action.handler;
            });

            var callServer = (function() {
                function request(url, method, data, callback){
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function(){
                        if (this.readyState == 4 && this.status == 200) {
                            if(callback) callback(this);
                        }
                    }
                    xhttp.open(method, url, true);
                    xhttp.send(data);
                }

                return {
                    get: function(url, callback){
                        request(url, "GET", null, callback);
                    },
                    post: function(url, data, callback){
                        request(url, "POST", data, callback);
                    }
                }
            })();

            (function refreshTemps(){
                return callServer.get("/get_temps", function(request){
                    var requestedData = JSON.parse(request.response);
                    var requestedLabels = [];
                    var requestedTempData = [];
                    var requestedBrewData = [];
                    var requestedSteamData = [];

                    [brewTarget, steamTarget, tempOffset] = [requestedData.targets.brew, requestedData.targets.steam, requestedData.targets.offset]
                    var sortedOutputs = requestedData.outputs.sort((a, b) => a.time - b.time);

                    sortedOutputs.forEach(output => {
                        requestedLabels.push(output.time * 1000);
                        requestedTempData.push(output.temperature);
                        requestedBrewData.push(output.outputs.brew);
                        requestedSteamData.push(output.outputs.steam);
                    })

                    chart.data.labels = requestedLabels;
                    chart.data.datasets[0].data = tempData = requestedTempData;
                    if(mode == 'brew') { chart.data.datasets[1].data = brewData = requestedBrewData }
                    else { chart.data.datasets[1].data = steamData = requestedSteamData }        
                    chart.update();
                    updateElements();
                    refreshTemps();
                });
            })();

            function refreshTunings() {
                callServer.get("/get_tunings", function(request){
                    var requestedData = JSON.parse(request.response);
                    Object.entries(requestedData).forEach(entry => {
                        const [name, value] = entry;
                        var input = document.getElementById(name);
                        input.value = value;
                    });
                });
            }

            refreshTunings();
            document.getElementById("targetplus").onclick = incrementTarget;
            document.getElementById("targetminus").onclick = decrementTarget;
            document.getElementById("offsetplus").onclick = incrementOffset;
            document.getElementById("offsetminus").onclick = decrementOffset;
            document.getElementById("tuning_button").onclick = changeTunings;
        }
    </script>
</head>
<body class="container-sm">
    <div class="row p-2" id="chartContainer">
        <canvas id="tempChart"></canvas>
    </div>
    <div class="row p-2 row-cols-2 row-cols-sm-5 align-items-center" id="tempContainer">
        <div class="col order-1">
            <button class="btn btn-outline-primary active" id="switch_brew"> Water Temp </button>
        </div>
        <div class=" col order-3 me-sm-auto">
            <button class="btn btn-outline-primary" id="switch_steam"> Steam Temp </button>
        </div>
        <div class="col row row-cols-1 row-cols-xl-2 order-2 order-sm-3"> 
            <label class="form-label col" id="target_label"> Target: 100 C</label>
            <div class="col-2 btn-group">
                <button class="btn btn-outline-danger" id="targetplus"> + </button>
                <button class="btn btn-outline-secondary" id="targetminus"> - </button>
            </div>
        </div>
        <div class="col row row-cols-1 row-cols-xl-2 order-4"> 
            <label class="form-label col" id="offset_label"> Offset: -8 C</label>
            <div class="col-2 btn-group">
                <button class="btn btn-outline-danger" id="offsetplus"> + </button>
                <button class="btn btn-outline-secondary" id="offsetminus"> - </button>
            </div>
        </div>
    </div>
    <div class="row p-2" id="tunerContainer">
        <p>
            <button class="btn btn-outline-primary" type="button" id="tuning_button" data-bs-toggle="collapse" data-bs-target="#tunings_tab">
                Set Tunings:
            </button>
        </p>
        <div class="collapse" id="tunings_tab">
            <form class="accordion-body" id="tunings-form">
                <div class="row">
                    <div class="tuning-button input-group col">
                        <span for="kp" class="input-group-text"> Kp: </span>
                        <input class="tuning-input form-control" type="text" id="kp" value="" placeholder="Proportional" min="0">
                        <button class="tuning-button btn btn-outline-secondary" type="button" id="kpplus"> + </button>
                        <button class="tuning-button btn btn-outline-secondary" type="button" id="kpminus"> - </button>
                    </div>
                    <div class="tuning-button input-group col">
                        <span for="kp" class="input-group-text"> Ki: </span>
                        <input class="tuning-input form-control" type="text" id="ki" value="" placeholder="Integral" min="0">
                        <button class="tuning-button btn btn-outline-secondary" type="button" id="kiplus"> + </button>
                        <button class="tuning-button btn btn-outline-secondary" type="button" id="kiminus"> - </button>
                    </div>
                    <div class="tuning-button input-group col">
                        <span for="kp" class="input-group-text"> Kd: </span>
                        <input class="tuning-input form-control" type="text" id="kd" value="" placeholder="Derivative" min="0">
                        <button class="tuning-button btn btn-outline-secondary" type="button" id="kdplus"> + </button>
                        <button class="tuning-button btn btn-outline-secondary" type="button" id="kdminus"> - </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.js" integrity="sha256-8AdWdyRXkrETyAGla9NmgkYVlqw4MOHR6sJJmtFGAYQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.4.1/dist/chart.min.js" integrity="sha256-GMN9UIJeUeOsn/Uq4xDheGItEeSpI5Hcfp/63GclDZk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js" integrity="sha256-sFB24K2xU2EOgWAtb3ySAGjhMqcUvUJGmwjDcTQa04k=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha256-XDbijJp72GS2c+Ij234ZNJIyJ1Nv+9+HH1i28JuayMk=" crossorigin="anonymous"></script>
</body>
</html>