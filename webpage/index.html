<html>
<head>
    <script>
        window.onload = function () {
            var defaultBrewTarget = 100;
            var defaultSteamTarget = 150;
            var brewData = {target: [], output: []};
            var steamData = {target: [], output: []};
            var labels = [];
            var data = {
                labels: labels,
                datasets: [{
                    type: 'line',
                    label: 'Temperature',
                    data: [],
                    borderColor: "#FF6384",
                    backgroundColor: "#FF6384",
                    yAxisID: 'y',
                }, {
                    type: 'bar',
                    label: 'Output',
                    data: brewData.output,
                    borderColor: "#63FFDD",
                    backgroundColor: "#63FFDD",
                    yAxisID: 'y1',
                }],
            };

            const options = {
                spanGaps: 1000,
                responsive: true,
                animations: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                plugins: {
                    decimation: {
                        enabled: 'true',
                        algorithm: 'lttb',
                        samples: 10,
                    },
                    title: {
                        display: true,
                        text: "Brew Temperature",
                    },
                },
                scales: {
                    x: {
                        type: 'timeseries',
                        time: {
                            unit: 'second',
                        },
                        ticks: {
                            display:false,
                        },
                        title: {
                            display: true,
                            text: "Time",
                        },
                        stepSize: 15,
                    },
                    y: {
                        suggestedMax: defaultBrewTarget,
                        title: {
                            display: true,
                            text: "Temperature",
                        },
                        position: 'left',
                        grid: {
                            color: function(context) {
                                if(brewData.target.length){
                                    if(context.tick.value == brewData.target[brewData.target.length - 1]) return "#FF6384";
                                }
                                else if(context.tick.value == defaultBrewTarget) return "#FF6384";
                            },
                        },
                    },
                    y1: {
                        suggestedMax: 1000,
                        title: {
                            display: true,
                            text: "Output",
                        },
                        position: "right",
                    },
                },
            }

            const actions = [{
                name: "Display Brew Temps",
                handler() {
                    chart.options.scales.y.suggestedMax = defaultBrewTarget;
                    chart.options.plugins.title.text = "Brew Temperature";
                    chart.options.scales.y.grid.color = function(context) {
                        if(brewData.target.length){
                            if(context.tick.value == brewData.target[brewData.target.length - 1]) return "#FF6384";
                        }
                        else if(context.tick.value == defaultBrewTarget) return "#FF6384";
                    },
                    chart.update();
                },
            }, {
                name: "Display Steam Temps",
                handler() {
                    chart.options.scales.y.suggestedMax = defaultSteamTarget;
                    chart.options.plugins.title.text = "Steam Temperature";
                    chart.options.scales.y.grid.color = function(context) {
                        if(steamData.target.length){
                            if(context.tick.value == steamData.target[steamData.target.length - 1]) return "#FF6384";
                        }
                        else if(context.tick.value == defaultSteamTarget) return "#FF6384";
                    },
                    chart.update();
                }
            }];

            const ctx = document.getElementById('tempChart').getContext('2d');
            var chart = new Chart(ctx, {
                data: data,
                options: options,
            });

            const container = document.getElementById('tempContainer');
            actions.forEach(function(action){
                const button = document.createElement('button');
                button.innerHTML = action.name;
                button.onclick = action.handler;
                container.appendChild(button);
            });

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function(){
                if (this.readyState == 4 && this.status == 200) {
                    var tempData = JSON.parse(this.response);
                    var time = Date.now();
                    labels.push(time);
                    chart.data.datasets[0].data.push(tempData.temperature);
                    brewData.target.push(tempData.brew.target);
                    brewData.output.push(tempData.brew.output);
                    steamData.target.push(tempData.steam.output);
                    steamData.output.push(tempData.steam.output);

                    if(chart.data.datasets[0].data.length > 120) {
                        labels.shift();
                        chart.data.datasets[0].data.shift();
                        brewData.target.shift();
                        steamData.target.shift();
                        brewData.output.shift();
                        steamData.output.shift();
                    }
                    chart.update();
                    pollServer(this);
                }
            }
            function pollServer(xhttp) {
                xhttp.open("GET", "/get_temps", true);
                xhttp.send();
            }
            pollServer(xhttp);
        }
    </script>
</head>
<body>
    <div id="tempContainer" class="chart-container" style="position:relative; height:40vh; width:120vh; margin:auto;">
        <canvas id="tempChart"></canvas>
    </div>
    <div class="controller-container" id="tempController" style="display:none">
        <div class="target-button-container"> 
            <p> Target: </p>
            <p id="targetTemp"> 95 C</p>
            <button id="incrementButton"> + </button>
            <button id="decrementButton"> - </button>
        </div>
        <div>
            <p> Tunings: </p>
            <div class="tuning-button-container">
                <p>Kp:</p>
                <input class="tuning-input" id="kp" value="">
                <button class="tuning-button" id="kpplus"> + </button>
                <button class="tuning-button" id="kpminus"> - </button>
            </div>
            <div class="tuning-button">
                <p>Ki:</p>
                <input class="tuning-input" id="ki" value="">
                <button class="tuning-button" id="kiplus"> + </button>
                <button class="tuning-button" id="kiminus"> - </button>
            </div>
            <div class="tuning-button">
                <p>Kd:</p>
                <input class="tuning-input" id="kd" value="">
                <button class="tuning-button" id="kdplus"> + </button>
                <button class="tuning-button" id="kdminus"> - </button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
</body>
</html>