<html>
<head>
    <script>
        window.onload = function () {
            var currentTemp = 0;
            var brewTarget = 100;
            var steamTarget = 145;
            var tempOffset = 8;
            var mode = 'brew';
            var brewData = {target: [], output: []};
            var steamData = {target: [], output: []};
            var labels = [];
            var data = {
                labels: labels,
                datasets: [{
                    type: 'line',
                    label: 'Temperature',
                    data: [],
                    borderColor: "#FF6384",
                    backgroundColor: "#FF6384",
                    yAxisID: 'y',
                }, {
                    type: 'bar',
                    label: 'Output',
                    data: brewData.output,
                    borderColor: "#63FFDD",
                    backgroundColor: "#63FFDD",
                    yAxisID: 'y1',
                }],
            };

            const options = {
                spanGaps: 1000,
                responsive: true,
                animations: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                plugins: {
                    decimation: {
                        enabled: 'true',
                        algorithm: 'lttb',
                        samples: 10,
                    },
                    title: {
                        display: true,
                        text: "Brew Temperature",
                    },
                },
                scales: {
                    x: {
                        type: 'timeseries',
                        time: {
                            unit: 'second',
                        },
                        ticks: {
                            display:false,
                        },
                        title: {
                            display: true,
                            text: "Time",
                        },
                        stepSize: 30,
                    },
                    y: {
                        suggestedMax: brewTarget,
                        title: {
                            display: true,
                            text: "Temperature",
                        },
                        position: 'left',
                        grid: {
                            color: function(context) {
                                if(context.tick.value == brewTarget) return "#FF6384";
                            },
                        },
                    },
                    y1: {
                        suggestedMax: 1000,
                        title: {
                            display: true,
                            text: "Output",
                        },
                        position: "right",
                    },
                },
            }

            const actions = [{
                name: "Display Brew Temps",
                id: "brew",
                handler() {
                    chart.options.scales.y.suggestedMax = brewTarget;
                    chart.options.plugins.title.text = "Brew Temperature";
                    chart.options.scales.y.grid.color = function(context) {
                        if(context.tick.value == brewTarget) return "#FF6384";
                    };
                    chart.datasets[1].data = brewData.output;
                    mode = 'brew';
                    tempPercent = brewTarget / currentTemp;
                    chart.update();
                    updateElements();
                },
            }, {
                name: "Display Steam Temps",
                id: "steam",
                handler() {
                    chart.options.scales.y.suggestedMax = steamTarget;
                    chart.options.plugins.title.text = "Steam Temperature";
                    chart.options.scales.y.grid.color = function(context) {
                        if(context.tick.value == steamTarget) return "#FF6384";
                    };
                    chart.datasets[1].data = steamData.output;
                    mode = 'steam';
                    tempPercent = steamTarget / currentTemp;
                    chart.update();
                    updateElements();
                }
            }];
            
            function updateElements(){

            }

            const ctx = document.getElementById('tempChart').getContext('2d');
            var chart = new Chart(ctx, {
                data: data,
                options: options,
            });

            const container = document.getElementById('tempContainer');
            actions.forEach(function(action){
                const button = document.getElementById("switch_" + action.id);
                button.onclick = action.handler;
            });
            
            function pollServer(xhttp, url) {
                xhttp.open("GET", url, true);
                xhttp.send();
            }
            function callServer(url, handler){
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function(){
                    if (this.readyState == 4 && this.status == 200) {
                        handler(this);
                    }
                }
                pollServer(xhttp, url);
            }

            callServer("/get_temps", function(inherit){
                var tempData = JSON.parse(inherit.response);
                var time = Date.now();

                brewTarget = tempData.brew.target;
                steamTarget = tempData.steam.target;
                tempOffset = tempData.offset;
                labels.push(time);

                currentTemp = tempData.temperature;
                chart.data.datasets[0].data.push(tempData.temperature);
                brewData.output.push(tempData.brew.output);
                steamData.output.push(tempData.steam.output);
                
                if(chart.data.datasets[0].data.length > 120) {
                    labels.shift();
                    chart.data.datasets[0].data.shift();
                    brewData.output.shift();
                    steamData.output.shift();
                }

                tempPercent = (mode == 'brew') ? brewTarget /  currentTemp * 100 : steamTarget / currentTemp * 100;
                chart.update();
                pollServer(inherit, "/get_temps");
            });
            callServer("/get_tunings", function(inherit){
                var tempData = JSON.parse(inherit.response);
                Object.entries(tempData).forEach(entry => {
                    const [name, value] = entry;
                    var input = document.getElementById(name);
                    input.value = value;
                });
            });
        }
    </script>
</head>
<body class="container">
    <div class="chart-container container" id="tempContainer">
        <canvas class="justify-content-md-center row" id="tempChart"></canvas>
        <div class="justify-content-md-center row">
            <div class="switch-button-container col">
                <button class="btn btn-outline-primary" id="switch_brew"><span class="d-none d-lg-inline"> Display </span> Brew Temps </button>
                <button class="btn btn-outline-primary" id="switch_steam"><span class="d-none d-lg-inline"> Display </span> Steam Temps </button>
            </div>
            <div class="target-button-container col"> 
                <label class="form-label col"> Target: 95 C</label>
                <button class="btn btn-outline-danger" id="targetplus"> + </button>
                <button class="btn btn-outline-secondary" id="targetminus"> - </button>
            </div>
            <div class="offset-button-container col"> 
                <label class="form-label"> Offset: 8 C</label>
                <button class="btn btn-outline-danger" id="offsetplus"> + </button>
                <button class="btn btn-outline-secondary" id="offsetminus"> - </button>
            </div>
        </div>
    </div>
    <div class="controller-container container" id="tempController">
        <label for="tunings-form" class="form-label"> Tunings: </label>
        <form class="row justify-content-md-center" id="tunings-form">
            <div class="tuning-button input-group col">
                <span for="kp" class="input-group-text"> Kp: </span>
                <input class="tuning-input form-control" type="text" id="kp" value="" placeholder="Proportional" min="0">
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kpplus"> + </button>
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kpminus"> - </button>
            </div>
            <div class="tuning-button input-group col">
                <span for="kp" class="input-group-text"> Ki: </span>
                <input class="tuning-input form-control" type="text" id="ki" value="" placeholder="Integral" min="0">
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kiplus"> + </button>
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kiminus"> - </button>
            </div>
            <div class="tuning-button input-group col">
                <span for="kp" class="input-group-text"> Kd: </span>
                <input class="tuning-input form-control" type="text" id="kd" value="" placeholder="Derivative" min="0">
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kdplus"> + </button>
                <button class="tuning-button btn btn-outline-secondary" type="button" id="kdminus"> - </button>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
</body>
</html>